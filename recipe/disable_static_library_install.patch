From 4bfa814eebe1006b3964fe0bf23656a8c4592d69 Mon Sep 17 00:00:00 2001
From: Silvio Traversaro <silvio@traversaro.it>
Date: Thu, 24 Apr 2025 16:00:38 +0200
Subject: [PATCH] Fix use of ZENOHC_INSTALL_STATIC_LIBRARY CMake option

---
 install/CMakeLists.txt         | 16 ++++++++++++----
 install/PackageConfig.cmake.in | 18 ++++++++++--------
 2 files changed, 22 insertions(+), 12 deletions(-)

diff --git a/install/CMakeLists.txt b/install/CMakeLists.txt
index 85c8543b6..0d53083ae 100644
--- a/install/CMakeLists.txt
+++ b/install/CMakeLists.txt
@@ -1,5 +1,11 @@
 message(STATUS "zenoh-c install")
 
+declare_cache_var(ZENOHC_INSTALL_STATIC_LIBRARY TRUE BOOL "Install zenoh-c static library")
+
+if(NOT ZENOHC_INSTALL_STATIC_LIBRARY AND NOT BUILD_SHARED_LIBS)
+    message(FATAL_ERROR "ZENOHC_INSTALL_STATIC_LIBRARY and BUILD_SHARED_LIBS cannot both be set to OFF")
+endif()
+
 #
 # Installation
 # For debug configuration installs libraries with 'd' added to filename
@@ -36,10 +42,12 @@ function(install_zenohc_lib configurations property_postfix package_name)
             COMPONENT dev)
     endif()
 
-    get_target_property(staticlib_path zenohc::static IMPORTED_LOCATION_${property_postfix})
-    get_target_property(NATIVE_STATIC_LIBS zenohc::static INTERFACE_LINK_LIBRARIES)
-    get_filename_component(STATICLIB ${staticlib_path} NAME)
-    install(FILES ${staticlib_path} DESTINATION ${CMAKE_INSTALL_LIBDIR} CONFIGURATIONS ${configurations} COMPONENT dev)
+    if(ZENOHC_INSTALL_STATIC_LIBRARY)
+        get_target_property(staticlib_path zenohc::static IMPORTED_LOCATION_${property_postfix})
+        get_target_property(NATIVE_STATIC_LIBS zenohc::static INTERFACE_LINK_LIBRARIES)
+        get_filename_component(STATICLIB ${staticlib_path} NAME)
+        install(FILES ${staticlib_path} DESTINATION ${CMAKE_INSTALL_LIBDIR} CONFIGURATIONS ${configurations} COMPONENT dev)
+    endif()
 
     set(CMAKE_INSTALL_CMAKEDIR "${CMAKE_INSTALL_LIBDIR}/cmake/${package_name}")
 
diff --git a/install/PackageConfig.cmake.in b/install/PackageConfig.cmake.in
index 670f5385a..5052f2905 100644
--- a/install/PackageConfig.cmake.in
+++ b/install/PackageConfig.cmake.in
@@ -31,14 +31,16 @@ if(NOT TARGET __zenohc_shared)
         set_property(TARGET __zenohc_shared PROPERTY IMPORTED_IMPLIB "@PACKAGE_CMAKE_INSTALL_LIBDIR@/@IMPLIB@")
     endif()
 endif()
-if(NOT TARGET __zenohc_static)
-    add_library(__zenohc_static STATIC IMPORTED GLOBAL)
-    add_library(zenohc::static ALIAS __zenohc_static)
-    target_link_libraries(__zenohc_static INTERFACE @NATIVE_STATIC_LIBS@)
-    set_target_properties(__zenohc_static PROPERTIES
-        IMPORTED_LOCATION "@PACKAGE_CMAKE_INSTALL_LIBDIR@/@STATICLIB@"
-        INTERFACE_INCLUDE_DIRECTORIES "@PACKAGE_CMAKE_INSTALL_INCLUDEDIR@"
-    )
+if(@ZENOHC_INSTALL_STATIC_LIBRARY@)
+    if(NOT TARGET __zenohc_static)
+        add_library(__zenohc_static STATIC IMPORTED GLOBAL)
+        add_library(zenohc::static ALIAS __zenohc_static)
+        target_link_libraries(__zenohc_static INTERFACE @NATIVE_STATIC_LIBS@)
+        set_target_properties(__zenohc_static PROPERTIES
+            IMPORTED_LOCATION "@PACKAGE_CMAKE_INSTALL_LIBDIR@/@STATICLIB@"
+            INTERFACE_INCLUDE_DIRECTORIES "@PACKAGE_CMAKE_INSTALL_INCLUDEDIR@"
+        )
+    endif()
 endif()
 
 if(NOT TARGET zenohc::lib)
